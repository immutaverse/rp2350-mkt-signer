name: 'rp2350-firmware-signer'
description: |
  PRE-ALPHA firmware signer action to enable secure boot
  for RP2350 series chips and pico2 '
inputs:
  FIRMWARE:
    description: 'Path to the previously generated uf2 firmware file'
    required: true
    default: 'workspace/firmware/firmware.uf2'
  BUILD_ACTION:
    description: |
      sign or build. 
      When set to sign FIRMWARE is MANDATORY 
      When set to build SOURCE_DIR is mandatory'
    required: true
    default: 'sign'
  PRIVATE_KEY:
    description: |
      Base64 encoded private key normally loaded from
      github secret but you can provide it from 
      any source.   
    required: false
    default: 'NOT-SET'
  OTP_FILE:
    description: |
      path to the OTP file to be used for signing
      you should have any fuse bits you need set 
      already defined in this file and the signer 
      will update it with the public key ready to 
      burn into your chips.  
    required: true
    default: 'workspace/firmware/otp_file.json'
  BOARD_NAME:
    description: | 
      this is the boardname passed into the build
      scripts.  normally only used when build_action
      is set to build. 
    required: false
    default: 'pico2'
  SOURCE_DIR: 
    description: |
      source directory containing source code to build
      with the SDK file.  Mandatory when build_action 
      is set to build. This is the directory where 
      you have saved your CMakeLists.txt See and example
      at https://github.com/immutaverse/rp2350-ex-blink-fast      
    required: false
    default: 'GitHub'
  SIGN_METADATA:
    description: |
      path to file contaiing Metadata to be included 
      in the signed firmware file.  This is a dictionary 
      of key value pairs.  Not all chip signiners use this
      the pico2 signer does not.
    required: false
    default: '{}'
  

#outputs:
#  message:
#    description: 'message from the executing the action '

branding:
  icon: 'award'
  color: 'green'


jobs:
  sign:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      attestations: read
      id-token: read
    env:  
      BUILD_ACTION: ${{ inputs.BUILD_ACTION }}
      OTP_FILE: ${{ inputs.OTP_FILE }}
      FIRMWARE: ${{ inputs.FIRMWARE }}
      PRIVATE_KEY: ${{ inputs.PRIVATE_KEY }}
      BOARD_NAME: ${{ inputs.BOARD_NAME }}
      SOURCE_DIR: ${{ inputs.SOURCE_DIR }}
      SIGN_LOG_LEVEL: ${{ inputs.SIGN_LOG_LEVEL }}
      DOCKER_WORKSPACE: "docker_workspace"
      DW_FIRMWARE: "docker_workspace/firmware"
      DW_OTP: "docker_workspace/otp.json"
      DW_FUSE: "docker_workspace/otp.sec-boot-blow-fuses.sh"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # RE: Principle of least access we only want to copy 
      # things needed for the docker image to perform the signing
      # to a directory where the docker image has access to them 
      # and we do not want to allow docker image access to full 
      # agent workspace file system. 
      - name: prepare signing input
        run: |
          python3 prepare-sign-input.py          
          
      - name: Log in to GitHub Container Registry (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin


      #TODO: We need to allow a version of the docker immage to be 
      #  specified so users can pull the one with the libraries they
      #  desire without needing a new marketplace action for each one.
      - name: Run Docker Container to perform the signing
        run: |
          docker pull ghcr.io/immutaverse/pico-builder:latest
          docker run --rm -it -v "$GITHUB_WORKSPACE/$DOCKER_WORKSPACE:/workspace" \
            -e PRIVATE_KEY="${{ inputs.PRIVATE_KEY }}" \
            -e FIRMWARE="${{ DW_FIRMWARE }}" \
            -e OTP_FILE="${{ DW_OTP }}" \
            -e BOARD_NAME="${{ inputs.BOARD_NAME }}" \
            -e BUILD_ACTION="${{ inputs.BUILD_ACTION }}" \
            -e SIGN_LOG_LEVEL="${{ inputs.SIGN_LOG_LEVEL }}" \
            pico-builder:latest

      - name: Copy Signed Assets Back normal target locations
        run: |
          # TODO: THESE ARE  ARE NOT QUITE RIGHT NEED TO COPY FROM OUR
          # WELL KNOWN LOCATION BACK TO NAME PROVIDED BY INPUT PARMS.
          # Probably need to do this in python 
          cp "$GITHUB_WORKSPACE/$DOCKER_WORKSPACE/firmware.signed" "$GITHUB_WORKSPACE/output/"
          cp "$GITHUB_WORKSPACE/$DOCKER_WORKSPACE/otp-final.json" "$GITHUB_WORKSPACE/output/"
          cp "$GITHUB_WORKSPACE/$DOCKER_WORKSPACE/otp.sec-boot-blow-fuses.sh" "$GITHUB_WORKSPACE/output/"

